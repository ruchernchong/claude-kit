services:
  # Test Claude Code installation only
  claude:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: powertools-claude
    volumes:
      - ..:/home/testuser/claude-powertools
    command: >
      bash -c "
        cd /home/testuser/claude-powertools &&
        echo '=== Testing Claude Code Installation ===' &&
        echo '' &&
        bash scripts/install-claude.sh &&
        echo '' &&
        echo '=== Verification ===' &&
        echo 'Skills installed:' &&
        ls -la ~/.claude/skills/ | grep -E '^l' | wc -l | xargs echo 'Total symlinks:' &&
        echo '' &&
        echo 'Sample symlinks:' &&
        (cd ~/.claude/skills/ && pwd) &&
        ls -la ~/.claude/skills/ | grep -E '^l' | head -3
      "

  # Test idempotency (running installer twice)
  idempotent:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: powertools-idempotent
    volumes:
      - ..:/home/testuser/claude-powertools
    command: >
      bash -c "
        cd /home/testuser/claude-powertools &&
        echo '=== Testing Idempotency ===' &&
        echo '' &&
        echo 'First run:' &&
        bash scripts/install-claude.sh >/dev/null 2>&1
        echo 'First install completed' &&
        echo '' &&
        echo 'Second run (should skip all):' &&
        bash scripts/install-claude.sh >/dev/null 2>&1
        echo 'Second install completed' &&
        echo '' &&
        echo '=== Verification ===' &&
        ls -la ~/.claude/skills/ 2>/dev/null | grep -c '^l' | xargs echo 'Claude symlinks:' &&
        exit 0
      "

  # Test symlink integrity
  symlinks:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: powertools-symlinks
    volumes:
      - ..:/home/testuser/claude-powertools
    command: >
      bash -c "
        cd /home/testuser/claude-powertools &&
        echo '=== Testing Symlink Integrity ===' &&
        echo '' &&
        bash scripts/install-claude.sh > /dev/null 2>&1
        echo 'Checking all symlinks point to valid files...' &&
        echo '' &&
        all_valid=true
        for file in ~/.claude/skills/*.md; do
          if [ -L \"$$file\" ]; then
            target=$$(readlink \"$$file\")
            if [ -f \"$$target\" ]; then
              echo \"✓ $$(basename \"$$file\") -> $$target\"
            else
              echo \"✗ $$(basename \"$$file\") -> $$target (BROKEN)\"
              all_valid=false
            fi
          fi
        done
        echo ''
        if [ \"$$all_valid\" = true ]; then
          echo '✅ All symlinks are valid'
          exit 0
        else
          echo '❌ Some symlinks are broken'
          exit 1
        fi
      "

  # Test warning messages
  warnings:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: powertools-warnings
    volumes:
      - ..:/home/testuser/claude-powertools
    command: >
      bash -c "
        cd /home/testuser/claude-powertools &&
        echo '=== Testing Warning Messages ===' &&
        echo '' &&
        echo 'Testing Claude Code installer warning...' &&
        output=$$(bash scripts/install-claude.sh 2>&1) &&
        if echo \"$$output\" | grep -q 'WARNING: Existing skills'; then
          echo '✓ Claude Code installer shows warning'
        else
          echo '✗ Claude Code installer missing warning'
          exit 1
        fi &&
        if echo \"$$output\" | grep -q 'We will attempt to backup'; then
          echo '✓ Claude Code installer mentions backup'
        else
          echo '✗ Claude Code installer missing backup message'
          exit 1
        fi &&
        echo '' &&
        echo '✅ All warning messages are present'
      "

  # Test backup functionality
  backup:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: powertools-backup
    volumes:
      - ..:/home/testuser/claude-powertools
    command: >
      bash -c "
        cd /home/testuser/claude-powertools &&
        echo '=== Testing Backup Functionality ===' &&
        echo '' &&
        echo 'Setting up test environment...' &&
        mkdir -p ~/.claude/skills &&
        echo '' &&
        echo '--- Test 1: First backup (should create .bak files) ---' &&
        echo 'Creating dummy files to be backed up...' &&
        echo 'custom skill 1' > ~/.claude/skills/build.md &&
        echo 'custom skill 2' > ~/.claude/skills/test.md &&
        echo '' &&
        echo 'Running Claude Code installer...' &&
        output=$$(bash scripts/install-claude.sh 2>&1) &&
        echo '' &&
        if [ -f ~/.claude/skills/build.md.bak ]; then
          echo '✓ First backup created: build.md.bak'
        else
          echo '✗ First backup NOT created: build.md.bak'
          exit 1
        fi &&
        if [ -f ~/.claude/skills/test.md.bak ]; then
          echo '✓ First backup created: test.md.bak'
        else
          echo '✗ First backup NOT created: test.md.bak'
          exit 1
        fi &&
        if grep -q 'custom skill 1' ~/.claude/skills/build.md.bak; then
          echo '✓ Backup contains original content'
        else
          echo '✗ Backup does NOT contain original content'
          exit 1
        fi &&
        if echo \"$$output\" | grep -q 'Backed up:.*2'; then
          echo '✓ Summary shows backed up count'
        else
          echo '✗ Summary missing backed up count'
          exit 1
        fi &&
        echo '' &&
        echo '--- Test 2: Second backup (should create timestamped .bak files) ---' &&
        echo 'Creating new dummy files...' &&
        rm ~/.claude/skills/build.md &&
        echo 'custom skill UPDATED' > ~/.claude/skills/build.md &&
        sleep 1 &&
        echo '' &&
        echo 'Running installer again...' &&
        bash scripts/install-claude.sh >/dev/null 2>&1 &&
        echo '' &&
        bak_count=$$(ls ~/.claude/skills/build.md.bak* 2>/dev/null | wc -l) &&
        if [ \"$$bak_count\" -ge 2 ]; then
          echo \"✓ Multiple backups exist ($$bak_count files)\"
        else
          echo \"✗ Second backup NOT created (only $$bak_count file)\"
          exit 1
        fi &&
        timestamped_backup=$$(ls ~/.claude/skills/build.md.bak.* 2>/dev/null | head -1) &&
        if [ -n \"$$timestamped_backup\" ]; then
          echo \"✓ Timestamped backup created: $$(basename \"$$timestamped_backup\")\"
        else
          echo '✗ No timestamped backup found'
          exit 1
        fi &&
        echo '' &&
        echo '--- Test 3: Symlinks should NOT be backed up ---' &&
        bash scripts/install-claude.sh >/dev/null 2>&1 &&
        bak_count=$$(ls ~/.claude/skills/build.md.bak* 2>/dev/null | wc -l) &&
        if [ \"$$bak_count\" -ge 2 ]; then
          echo '✓ Previous backups preserved'
        else
          echo \"✗ Unexpected backup count (got $$bak_count)\"
          exit 1
        fi &&
        echo 'Running installer again (symlink should not be backed up)...' &&
        output2=$$(bash scripts/install-claude.sh 2>&1) &&
        bak_count=$$(ls ~/.claude/skills/build.md.bak* 2>/dev/null | wc -l) &&
        if [ \"$$bak_count\" -ge 2 ]; then
          echo '✓ Symlink NOT backed up (backup count stable)'
        else
          echo \"✗ Unexpected backup behavior (got $$bak_count)\"
          exit 1
        fi &&
        echo '' &&
        echo '✅ All backup tests passed'
      "

  # Interactive test environment (for manual testing)
  interactive:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: powertools-interactive
    volumes:
      - ..:/home/testuser/claude-powertools
    stdin_open: true
    tty: true
    command: bash
