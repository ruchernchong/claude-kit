services:
  # Test Claude Code installation only
  claude:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: claude-kit-claude
    volumes:
      - ..:/home/testuser/claude-kit
    command: >
      bash -c "
        cd /home/testuser/claude-kit &&
        echo '=== Testing Claude Code Installation ===' &&
        echo '' &&
        pnpm install-commands --ci &&
        echo '' &&
        echo '=== Verification ===' &&
        echo 'Commands installed:' &&
        ls -la ~/.claude/commands/ | grep -E '^l' | wc -l | xargs echo 'Total symlinks:' &&
        echo '' &&
        echo 'Sample symlinks:' &&
        (cd ~/.claude/commands/ && pwd) &&
        ls -la ~/.claude/commands/ | grep -E '^l' | head -3
      "

  # Test idempotency (running installer twice)
  idempotent:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: claude-kit-idempotent
    volumes:
      - ..:/home/testuser/claude-kit
    command: >
      bash -c "
        cd /home/testuser/claude-kit &&
        echo '=== Testing Idempotency ===' &&
        echo '' &&
        echo 'First run:' &&
        pnpm install-commands --ci >/dev/null 2>&1
        echo 'First install completed' &&
        echo '' &&
        echo 'Second run (should skip all):' &&
        pnpm install-commands --ci >/dev/null 2>&1
        echo 'Second install completed' &&
        echo '' &&
        echo '=== Verification ===' &&
        ls -la ~/.claude/commands/ 2>/dev/null | grep -c '^l' | xargs echo 'Claude symlinks:' &&
        exit 0
      "

  # Test symlink integrity
  symlinks:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: claude-kit-symlinks
    volumes:
      - ..:/home/testuser/claude-kit
    command: >
      bash -c "
        cd /home/testuser/claude-kit &&
        echo '=== Testing Symlink Integrity ===' &&
        echo '' &&
        pnpm install-commands --ci > /dev/null 2>&1
        echo 'Checking all symlinks point to valid files...' &&
        echo '' &&
        all_valid=true
        for file in ~/.claude/commands/*.md; do
          if [ -L \"\$$file\" ]; then
            target=\$$(readlink \"\$$file\")
            if [ -f \"\$$target\" ]; then
              echo \"✓ \$$(basename \"\$$file\") -> \$$target\"
            else
              echo \"✗ \$$(basename \"\$$file\") -> \$$target (BROKEN)\"
              all_valid=false
            fi
          fi
        done
        echo ''
        if [ \"\$$all_valid\" = true ]; then
          echo '✅ All symlinks are valid'
          exit 0
        else
          echo '❌ Some symlinks are broken'
          exit 1
        fi
      "

  # Test warning messages
  warnings:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: claude-kit-warnings
    volumes:
      - ..:/home/testuser/claude-kit
    command: >
      bash -c "
        cd /home/testuser/claude-kit &&
        echo '=== Testing Warning Messages ===' &&
        echo '' &&
        echo 'Testing installer warning...' &&
        output=\$$(pnpm install-commands --ci 2>&1) &&
        if echo \"\$$output\" | grep -q 'WARNING: Existing commands'; then
          echo '✓ Installer shows warning'
        else
          echo '✗ Installer missing warning'
          exit 1
        fi &&
        if echo \"\$$output\" | grep -q 'Backups will be saved'; then
          echo '✓ Installer mentions backup'
        else
          echo '✗ Installer missing backup message'
          exit 1
        fi &&
        echo '' &&
        echo '✅ All warning messages are present'
      "

  # Test backup functionality
  backup:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: claude-kit-backup
    volumes:
      - ..:/home/testuser/claude-kit
    command: >
      bash -c "
        cd /home/testuser/claude-kit &&
        echo '=== Testing Backup Functionality ===' &&
        echo '' &&
        echo 'Setting up test environment...' &&
        mkdir -p ~/.claude/commands &&
        echo '' &&
        echo '--- Test 1: First backup (should create .bak files) ---' &&
        echo 'Creating dummy files to be backed up...' &&
        echo 'custom command 1' > ~/.claude/commands/commit.md &&
        echo 'custom command 2' > ~/.claude/commands/new-branch.md &&
        echo '' &&
        echo 'Running installer...' &&
        output=\$$(pnpm install-commands --ci 2>&1) &&
        echo '' &&
        if [ -f ~/.claude/commands/commit.md.bak ]; then
          echo '✓ First backup created: commit.md.bak'
        else
          echo '✗ First backup NOT created: commit.md.bak'
          exit 1
        fi &&
        if [ -f ~/.claude/commands/new-branch.md.bak ]; then
          echo '✓ First backup created: new-branch.md.bak'
        else
          echo '✗ First backup NOT created: new-branch.md.bak'
          exit 1
        fi &&
        if grep -q 'custom command 1' ~/.claude/commands/commit.md.bak; then
          echo '✓ Backup contains original content'
        else
          echo '✗ Backup does NOT contain original content'
          exit 1
        fi &&
        echo '' &&
        echo '--- Test 2: Second backup (should create timestamped .bak files) ---' &&
        echo 'Creating new dummy files...' &&
        rm ~/.claude/commands/commit.md &&
        echo 'custom command UPDATED' > ~/.claude/commands/commit.md &&
        sleep 1 &&
        echo '' &&
        echo 'Running installer again...' &&
        pnpm install-commands --ci >/dev/null 2>&1 &&
        echo '' &&
        bak_count=\$$(ls ~/.claude/commands/commit.md.bak* 2>/dev/null | wc -l) &&
        if [ \"\$$bak_count\" -ge 2 ]; then
          echo \"✓ Multiple backups exist (\$$bak_count files)\"
        else
          echo \"✗ Second backup NOT created (only \$$bak_count file)\"
          exit 1
        fi &&
        timestamped_backup=\$$(ls ~/.claude/commands/commit.md.bak.* 2>/dev/null | head -1) &&
        if [ -n \"\$$timestamped_backup\" ]; then
          echo \"✓ Timestamped backup created: \$$(basename \"\$$timestamped_backup\")\"
        else
          echo '✗ No timestamped backup found'
          exit 1
        fi &&
        echo '' &&
        echo '--- Test 3: Symlinks should NOT be backed up ---' &&
        pnpm install-commands --ci >/dev/null 2>&1 &&
        bak_count=\$$(ls ~/.claude/commands/commit.md.bak* 2>/dev/null | wc -l) &&
        if [ \"\$$bak_count\" -ge 2 ]; then
          echo '✓ Previous backups preserved'
        else
          echo \"✗ Unexpected backup count (got \$$bak_count)\"
          exit 1
        fi &&
        echo 'Running installer again (symlink should not be backed up)...' &&
        output2=\$$(pnpm install-commands --ci 2>&1) &&
        bak_count=\$$(ls ~/.claude/commands/commit.md.bak* 2>/dev/null | wc -l) &&
        if [ \"\$$bak_count\" -ge 2 ]; then
          echo '✓ Symlink NOT backed up (backup count stable)'
        else
          echo \"✗ Unexpected backup behavior (got \$$bak_count)\"
          exit 1
        fi &&
        echo '' &&
        echo '✅ All backup tests passed'
      "

  # Interactive test environment (for manual testing)
  interactive:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: claude-kit-interactive
    volumes:
      - ..:/home/testuser/claude-kit
    stdin_open: true
    tty: true
    command: bash
